{% extends "base.html" %}

{% block title %}Order Details - MediPlant{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="display-6 fw-bold text-primary mb-2">
                <i class="fas fa-receipt me-3"></i>Order #{{ order.id }}
            </h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}" class="text-decoration-none">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('my_orders') }}" class="text-decoration-none">My Orders</a></li>
                    <li class="breadcrumb-item active">Order #{{ order.id }}</li>
                </ol>
            </nav>
        </div>
        <div class="col-md-4 text-end">
            <span class="badge 
                {% if order.status == 'pending' %}bg-warning
                {% elif order.status == 'confirmed' %}bg-info  
                {% elif order.status == 'shipped' %}bg-primary
                {% elif order.status == 'delivered' %}bg-success
                {% elif order.status == 'cancelled' %}bg-danger
                {% else %}bg-secondary{% endif %} fs-5">
                {% if order.status == 'pending' %}
                    <i class="fas fa-clock me-1"></i>Pending
                {% elif order.status == 'confirmed' %}
                    <i class="fas fa-check me-1"></i>Confirmed
                {% elif order.status == 'shipped' %}
                    <i class="fas fa-truck me-1"></i>Shipped
                {% elif order.status == 'delivered' %}
                    <i class="fas fa-check-circle me-1"></i>Delivered
                {% elif order.status == 'cancelled' %}
                    <i class="fas fa-times me-1"></i>Cancelled
                {% else %}
                    <i class="fas fa-info me-1"></i>{{ order.status.title() }}
                {% endif %}
            </span>
        </div>
    </div>

    <div class="row">
        <!-- Order Items -->
        <div class="col-lg-8">
            <div class="card shadow-soft mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-box me-2"></i>Order Items
                    </h5>
                </div>
                <div class="card-body">
                    {% for item in order_items %}
                    <div class="d-flex align-items-center border-bottom pb-3 mb-3">
                        <img src="{{ item.image_url or 'https://images.unsplash.com/photo-1518799175676-a0fed7996acb?ixlib=rb-4.0.3&auto=format&fit=crop&w=80&q=80' }}" 
                             class="rounded me-3" width="80" height="80" alt="{{ item.name }}">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">{{ item.name }}</h6>
                            <p class="text-muted mb-1 small">{{ item.description[:100] }}{% if item.description|length > 100 %}...{% endif %}</p>
                            <div class="d-flex align-items-center">
                                <span class="text-primary fw-semibold">{{ item.price|inr }}</span>
                                <span class="text-muted mx-2">Ã—</span>
                                <span class="badge bg-light text-dark">{{ item.quantity }}</span>
                                <span class="text-muted mx-2">=</span>
                                <span class="fw-bold">{{ (item.price * item.quantity)|inr }}</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <a href="{{ url_for('product_detail', product_id=item.product_id) }}" 
                               class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-eye me-1"></i>View
                            </a>
                            {% if order.status == 'delivered' %}
                            <button class="btn btn-outline-success btn-sm ms-1" 
                                    onclick="showReviewModal({{ item.product_id }}, '{{ item.name }}')">
                                <i class="fas fa-star me-1"></i>Review
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Order Timeline -->
            <div class="card shadow-soft">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Order Timeline
                    </h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item active">
                            <div class="timeline-marker bg-success">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Order Placed</h6>
                                <p class="text-muted mb-0">{{ order.created_at }}</p>
                            </div>
                        </div>
                        
                        {% if order.status in ['confirmed', 'shipped', 'delivered'] %}
                        <div class="timeline-item active">
                            <div class="timeline-marker bg-info">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Order Confirmed</h6>
                                <p class="text-muted mb-0">Payment verified and order processing started</p>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if order.status in ['shipped', 'delivered'] %}
                        <div class="timeline-item active">
                            <div class="timeline-marker bg-primary">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Order Shipped</h6>
                                <p class="text-muted mb-1">Your order is on the way</p>
                                {% if order.tracking_number %}
                                <p class="text-muted mb-0">Tracking: <strong>{{ order.tracking_number }}</strong></p>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if order.status == 'delivered' %}
                        <div class="timeline-item active">
                            <div class="timeline-marker bg-success">
                                <i class="fas fa-home"></i>
                            </div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Order Delivered</h6>
                                <p class="text-muted mb-0">{{ order.delivered_at or 'Delivered successfully' }}</p>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if order.status == 'cancelled' %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-danger">
                                <i class="fas fa-times"></i>
                            </div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Order Cancelled</h6>
                                <p class="text-muted mb-0">Order was cancelled</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="col-lg-4">
            <!-- Order Summary Card -->
            <div class="card shadow-soft mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-calculator me-2"></i>Order Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal</span>
                        <span>{{ order.total_amount|inr }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Shipping</span>
                        <span class="text-success">Free</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tax</span>
                        <span>Included</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fw-bold">
                        <span>Total</span>
                        <span class="text-primary">{{ order.total_amount|inr }}</span>
                    </div>
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-credit-card me-1"></i>
                            Payment Method: {{ order.payment_method.upper() if order.payment_method else 'COD' }}
                        </small>
                    </div>
                </div>
            </div>

            <!-- Shipping Information -->
            <div class="card shadow-soft mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-truck me-2"></i>Shipping Information
                    </h5>
                </div>
                <div class="card-body">
                    <h6 class="mb-2">{{ order.full_name }}</h6>
                    <p class="text-muted mb-1">
                        {{ order.shipping_address }}<br>
                        {% if order.city %}{{ order.city }}{% endif %}
                        {% if order.state and order.city %}, {% endif %}
                        {% if order.state %}{{ order.state }}{% endif %}
                        {% if order.postal_code %} - {{ order.postal_code }}{% endif %}
                    </p>
                    {% if order.phone %}
                    <p class="text-muted mb-0">
                        <i class="fas fa-phone me-1"></i>{{ order.phone }}
                    </p>
                    {% endif %}
                </div>
            </div>

            <!-- Actions -->
            <div class="card shadow-soft">
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if order.status == 'pending' %}
                        <button class="btn btn-outline-danger" onclick="cancelOrder({{ order.id }})">
                            <i class="fas fa-times me-2"></i>Cancel Order
                        </button>
                        {% endif %}
                        
                        {% if order.status == 'delivered' %}
                        <button class="btn btn-outline-success" onclick="downloadInvoice({{ order.id }})">
                            <i class="fas fa-download me-2"></i>Download Invoice
                        </button>
                        {% endif %}
                        
                        <a href="{{ url_for('my_orders') }}" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Orders
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Write a Review</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="reviewForm" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Rating</label>
                        <div class="rating-input">
                            <input type="radio" name="rating" value="5" id="star5">
                            <label for="star5" title="5 stars"><i class="fas fa-star"></i></label>
                            <input type="radio" name="rating" value="4" id="star4">
                            <label for="star4" title="4 stars"><i class="fas fa-star"></i></label>
                            <input type="radio" name="rating" value="3" id="star3">
                            <label for="star3" title="3 stars"><i class="fas fa-star"></i></label>
                            <input type="radio" name="rating" value="2" id="star2">
                            <label for="star2" title="2 stars"><i class="fas fa-star"></i></label>
                            <input type="radio" name="rating" value="1" id="star1">
                            <label for="star1" title="1 star"><i class="fas fa-star"></i></label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="reviewText" class="form-label">Your Review</label>
                        <textarea class="form-control" id="reviewText" name="review_text" rows="4" 
                                  placeholder="Share your experience with this product..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Review</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentProductId = null;

function showReviewModal(productId, productName) {
    currentProductId = productId;
    document.querySelector('#reviewModal .modal-title').textContent = `Write a Review for ${productName}`;
    document.getElementById('reviewForm').action = `/add_review/${productId}`;
    new bootstrap.Modal(document.getElementById('reviewModal')).show();
}

function cancelOrder(orderId) {
    if (confirm('Are you sure you want to cancel this order?')) {
        fetch(`/cancel_order/${orderId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                reason: 'Cancelled by customer'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                location.reload();
            } else {
                showToast(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error cancelling order', 'danger');
        });
    }
}

function downloadInvoice(orderId) {
    window.open(`/download_invoice/${orderId}`, '_blank');
}

function showToast(message, type) {
    // Create toast notification
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toast = new bootstrap.Toast(toastContainer.lastElementChild);
    toast.show();
}

// Star rating functionality
document.addEventListener('DOMContentLoaded', function() {
    const ratingInputs = document.querySelectorAll('.rating-input input[type="radio"]');
    const ratingLabels = document.querySelectorAll('.rating-input label');
    
    ratingLabels.forEach((label, index) => {
        label.addEventListener('mouseover', function() {
            highlightStars(5 - index);
        });
        
        label.addEventListener('click', function() {
            ratingInputs[index].checked = true;
        });
    });
    
    document.querySelector('.rating-input').addEventListener('mouseleave', function() {
        const checkedInput = document.querySelector('.rating-input input[type="radio"]:checked');
        if (checkedInput) {
            const checkedIndex = Array.from(ratingInputs).indexOf(checkedInput);
            highlightStars(5 - checkedIndex);
        } else {
            highlightStars(0);
        }
    });
    
    function highlightStars(count) {
        ratingLabels.forEach((label, index) => {
            if (index < count) {
                label.classList.add('active');
            } else {
                label.classList.remove('active');
            }
        });
    }
});
</script>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}

.timeline-item {
    position: relative;
    margin-bottom: 30px;
}

.timeline-item.active .timeline-marker {
    background: var(--bs-success) !important;
}

.timeline-marker {
    position: absolute;
    left: -22px;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
}

.timeline-content h6 {
    margin-bottom: 5px;
    color: #495057;
}

.timeline-content p {
    margin-bottom: 0;
    font-size: 14px;
}

.rating-input {
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
}

.rating-input input[type="radio"] {
    display: none;
}

.rating-input label {
    cursor: pointer;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ddd;
    font-size: 20px;
    transition: color 0.2s;
}

.rating-input label:hover,
.rating-input label.active {
    color: #ffc107;
}

.rating-input input[type="radio"]:checked ~ label {
    color: #ffc107;
}
</style>
{% endblock %}
